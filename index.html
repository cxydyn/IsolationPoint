<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isolation Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- PDF Rendering Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #canvas-container { cursor: grab; }
        #canvas-container:active { cursor: grabbing; }
        .marker {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            pointer-events: auto;
            font-size: 14px;
        }
        .marker:hover { transform: scale(1.2); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        .context-menu {
            display: none;
            position: absolute;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            padding: 8px;
            min-width: 180px;
        }
        .context-menu button {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        .context-menu button:hover { background-color: #f3f4f6; }
        .sidebar-item { transition: background-color 0.2s; }
        .sidebar-item.active { background-color: #e0e7ff; color: #4f46e5; }
        .pdf-thumbnail {
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s;
            padding: 4px;
            border-radius: 8px;
        }
        .pdf-thumbnail:hover, .pdf-thumbnail.selected {
            border-color: #4f46e5;
        }
        .pdf-thumbnail canvas {
            width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #pdf-preview-container { cursor: grab; }
        #pdf-preview-container:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-white shadow-lg flex flex-col">
            <div class="p-5 border-b flex items-center gap-3">
                <svg class="w-8 h-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Isolation Manager</h1>
                    <p class="text-xs text-gray-500">LOTO Projects</p>
                </div>
            </div>

            <!-- Project Management -->
            <div class="p-5 border-b">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">Projects</h2>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="project-name" placeholder="New Project Name..." class="flex-grow w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="create-project-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Create</button>
                </div>
                <div class="mb-3">
                    <label class="w-full cursor-pointer text-center px-4 py-2 bg-gray-600 text-white text-sm font-semibold rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 block">
                        <span>Upload Project (.json)</span>
                        <input type="file" id="upload-project-input" accept=".json" class="sr-only">
                    </label>
                </div>
                <div id="project-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
            
            <!-- Fallback Upload Section (Initially Hidden) -->
            <div id="fallback-upload-section" class="hidden p-5 border-b bg-yellow-50 border-yellow-200">
                <p class="text-sm text-yellow-800 mb-2 font-semibold">Failed to Load Drawing</p>
                <p class="text-xs text-yellow-700 mb-3">Please upload a new drawing to start this session.</p>
                <label class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer">
                    <span>Upload New Drawing</span>
                    <input type="file" id="fallback-upload-input" accept="image/*,application/pdf" class="sr-only">
                </label>
            </div>

            <!-- Project Details & Actions -->
            <div id="project-details-section" class="p-5 border-b hidden">
                 <h2 class="text-lg font-semibold mb-3 text-gray-700">Project Details</h2>
                 <div class="mb-3">
                     <label for="project-work-desc" class="block text-sm font-medium text-gray-700">Description of Work</label>
                     <input type="text" id="project-work-desc" placeholder="e.g., Annual Pump Maintenance" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                 </div>
                 <button id="print-report-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 S 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                     <span>Print Report & Export JSON</span>
                 </button>
            </div>

            <!-- Isolation Points List -->
            <div id="isolation-points-section" class="flex-grow flex flex-col min-h-0 p-5">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">Isolation Points</h2>
                <div id="points-list" class="space-y-3 flex-grow overflow-y-auto pr-2"></div>
                <div id="no-points-message" class="text-center py-8 px-4 border-2 border-dashed rounded-lg mt-4">
                    <p class="text-gray-500">No isolation points yet.</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-6 bg-gray-100 flex flex-col">
              <div id="canvas-container" class="relative w-full h-full bg-white rounded-lg flex items-center justify-center overflow-hidden shadow-md">
                  <canvas id="sld-canvas"></canvas>
                  <div id="marker-container" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
                  <div id="canvas-placeholder" class="text-center p-10">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                      <h3 class="mt-2 text-sm font-medium text-gray-900">No Project Selected</h3>
                      <p class="mt-1 text-sm text-gray-500">Create or select a project to start.</p>
                      <div class="mt-6">
                          <label class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer">
                              <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                              <span>Upload Drawing for New Project</span>
                              <input type="file" id="sld-upload" accept="image/*,application/pdf" class="sr-only">
                          </label>
                      </div>
                  </div>
                  <!-- View Controls Toolbar -->
                  <div id="view-controls" class="absolute top-4 right-4 bg-white bg-opacity-80 backdrop-blur-sm rounded-lg shadow-lg p-2 flex gap-2 hidden">
                      <button id="zoom-in-btn" class="control-btn p-2 rounded-md hover:bg-gray-200" title="Zoom In"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button>
                      <button id="zoom-out-btn" class="control-btn p-2 rounded-md hover:bg-gray-200" title="Zoom Out"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button>
                      <button id="reset-view-btn" class="control-btn p-2 rounded-md hover:bg-gray-200" title="Reset View"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 8 0 018-8h.5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12a8 8 0 01-8 8h-.5"></path></svg></button>
                  </div>
              </div>
        </main>
    </div>

    <!-- Point Details Modal -->
    <div id="point-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4">
            <h2 class="text-2xl font-bold mb-4" id="modal-title">Isolation Point Details</h2>
            <form id="point-form">
                <input type="hidden" id="point-id">
                <input type="hidden" id="point-status">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="point-sequence" class="block text-sm font-medium text-gray-700">No.</label>
                            <input type="number" id="point-sequence" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 1" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="point-name" class="block text-sm font-medium text-gray-700">Equipment Name/Tag</label>
                            <input type="text" id="point-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., CB-01 Feeder A" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                           <label for="point-location" class="block text-sm font-medium text-gray-700">Location</label>
                           <input type="text" id="point-location" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., MCC Room">
                        </div>
                         <div>
                           <label for="point-device-type" class="block text-sm font-medium text-gray-700">Isolation Device Type</label>
                           <input type="text" id="point-device-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Breaker, Valve">
                        </div>
                        <div>
                            <label for="point-isolation-type" class="block text-sm font-medium text-gray-700">Isolation Type</label>
                            <select id="point-isolation-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>Electrical</option>
                                <option>Physical</option>
                            </select>
                        </div>
                    </div>
                     <div class="p-4 border rounded-md bg-gray-50">
                         <h3 class="text-lg font-medium text-gray-800 mb-3">Isolation</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                 <label for="point-normal-pos" class="block text-sm font-medium text-gray-700">Normal Position</label>
                                 <input type="text" id="point-normal-pos" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Closed, On">
                             </div>
                              <div>
                                 <label for="point-isolated-pos" class="block text-sm font-medium text-gray-700">Isolated Position</label>
                                 <input type="text" id="point-isolated-pos" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Open, Off">
                             </div>
                              <div>
                                 <label for="point-lock-no" class="block text-sm font-medium text-gray-700">Tag/Lock No.</label>
                                 <input type="text" id="point-lock-no" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., L-123">
                             </div>
                             <div>
                                 <label for="point-pic" class="block text-sm font-medium text-gray-700">PIC</label>
                                 <input type="text" id="point-pic" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Technician's Name">
                             </div>
                              <div class="md:col-span-2">
                                 <label for="point-datetime" class="block text-sm font-medium text-gray-700">Date/Time</label>
                                 <input type="datetime-local" id="point-datetime" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             </div>
                         </div>
                       </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="delete-point-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete</button>
                    <button type="button" id="close-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Page Selector Modal -->
    <div id="pdf-page-selector-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-6xl m-4 h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold">Select a Page</h2>
                <button id="close-pdf-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 flex-grow min-h-0">
                <!-- Thumbnails container -->
                <div class="w-full md:w-1/4 lg:w-1/5 border-r pr-4">
                    <h3 class="font-semibold mb-2 text-center">Pages</h3>
                    <div id="pdf-thumbnails-container" class="grid grid-cols-2 gap-2 max-h-full overflow-y-auto">
                        <!-- Thumbnails will be injected here -->
                    </div>
                </div>
                <!-- Preview container -->
                <div class="w-full md:w-3/4 lg:w-4/5 flex flex-col">
                    <div id="pdf-preview-container" class="flex-grow relative bg-gray-200 rounded-lg flex items-center justify-center min-h-0 overflow-hidden">
                        <canvas id="pdf-preview-canvas"></canvas>
                         <!-- Zoom Controls for Preview -->
                        <div class="absolute top-2 right-2 bg-white bg-opacity-70 rounded-md p-1 flex gap-1">
                            <button id="zoom-in-preview-btn" class="p-1.5 rounded-md hover:bg-gray-200" title="Zoom In"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button>
                            <button id="zoom-out-preview-btn" class="p-1.5 rounded-md hover:bg-gray-200" title="Zoom Out"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg></button>
                            <button id="reset-view-preview-btn" class="p-1.5 rounded-md hover:bg-gray-200" title="Reset View"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 8 0 018-8h.5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12a8 8 0 01-8 8h-.5"></path></svg></button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4 flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <button id="pdf-prev-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                            <span id="pdf-page-info" class="font-semibold">Page 0 of 0</span>
                            <button id="pdf-next-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                        </div>
                        <button id="select-pdf-page-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">Select This Page</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <button id="add-point-menu-btn">
            <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
            <span>Add Isolation Point</span>
        </button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
        const { jsPDF } = window.jspdf;

        // DOM Elements
        const sldUpload = document.getElementById('sld-upload');
        const printReportBtn = document.getElementById('print-report-btn');
        const canvasContainer = document.getElementById('canvas-container');
        const canvas = document.getElementById('sld-canvas');
        const ctx = canvas.getContext('2d');
        const canvasPlaceholder = document.getElementById('canvas-placeholder');
        const noPointsMessage = document.getElementById('no-points-message');
        const pointsList = document.getElementById('points-list');
        const markerContainer = document.getElementById('marker-container');
        const pointModal = document.getElementById('point-modal');
        const modalTitle = document.getElementById('modal-title');
        const pointForm = document.getElementById('point-form');
        const pointIdInput = document.getElementById('point-id');
        const pointSequenceInput = document.getElementById('point-sequence');
        const pointNameInput = document.getElementById('point-name');
        const pointLocationInput = document.getElementById('point-location');
        const pointDeviceTypeInput = document.getElementById('point-device-type');
        const pointIsolationTypeInput = document.getElementById('point-isolation-type');
        const pointStatusInput = document.getElementById('point-status');
        const pointNormalPosInput = document.getElementById('point-normal-pos');
        const pointIsolatedPosInput = document.getElementById('point-isolated-pos');
        const pointLockNoInput = document.getElementById('point-lock-no');
        const pointPicInput = document.getElementById('point-pic');
        const pointDatetimeInput = document.getElementById('point-datetime');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const deletePointBtn = document.getElementById('delete-point-btn');
        const contextMenu = document.getElementById('context-menu');
        const addPointMenuBtn = document.getElementById('add-point-menu-btn');
        const viewControls = document.getElementById('view-controls');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const resetViewBtn = document.getElementById('reset-view-btn');
        const projectNameInput = document.getElementById('project-name');
        const createProjectBtn = document.getElementById('create-project-btn');
        const projectList = document.getElementById('project-list');
        const projectDetailsSection = document.getElementById('project-details-section');
        const projectWorkDescInput = document.getElementById('project-work-desc');
        const fallbackUploadSection = document.getElementById('fallback-upload-section');
        const fallbackUploadInput = document.getElementById('fallback-upload-input');
        const uploadProjectInput = document.getElementById('upload-project-input');
        const pdfPageSelectorModal = document.getElementById('pdf-page-selector-modal');
        const pdfThumbnailsContainer = document.getElementById('pdf-thumbnails-container');
        const closePdfModalBtn = document.getElementById('close-pdf-modal-btn');
        const pdfPreviewContainer = document.getElementById('pdf-preview-container');
        const pdfPreviewCanvas = document.getElementById('pdf-preview-canvas');
        const pdfPrevBtn = document.getElementById('pdf-prev-btn');
        const pdfNextBtn = document.getElementById('pdf-next-btn');
        const pdfPageInfo = document.getElementById('pdf-page-info');
        const selectPdfPageBtn = document.getElementById('select-pdf-page-btn');
        const zoomInPreviewBtn = document.getElementById('zoom-in-preview-btn');
        const zoomOutPreviewBtn = document.getElementById('zoom-out-preview-btn');
        const resetViewPreviewBtn = document.getElementById('reset-view-preview-btn');

        // App State
        let projects = {};
        let activeProjectName = null;
        let image = null;
        let currentContextMenuPos = { x: 0, y: 0 };
        let currentPdf = null;
        let currentPageNumber = 1;
        let currentPdfProcessCallback = null;
        
        // Main Canvas Transformation State
        let scale = 1.0;
        let panOffset = { x: 0, y: 0 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };

        // PDF Preview Transformation State
        let previewScale = 1.0;
        let basePreviewScale = 1.0;
        let previewPanOffset = { x: 0, y: 0 };
        let isPreviewPanning = false;
        let previewPanStart = { x: 0, y: 0 };
        let previewPageCanvas = document.createElement('canvas'); // The offscreen canvas for smooth panning

        /**
         * Redraws the canvas, applying current scale and pan transformations.
         */
        function redrawAll() {
            if (!image) return;
            // Set canvas to full container size
            canvas.width = canvasContainer.clientWidth;
            canvas.height = canvasContainer.clientHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            // Move origin to center of canvas, apply pan, then scale
            ctx.translate(canvas.width / 2 + panOffset.x, canvas.height / 2 + panOffset.y);
            ctx.scale(scale, scale);
            // Draw image centered on the new origin
            ctx.drawImage(image, -image.width / 2, -image.height / 2, image.width, image.height);
            ctx.restore();
            
            updateMarkers();
        }
        
        /**
         * Resets the view to the initial fitted state.
         */
        function resetView() {
            fitImageToContainer();
            redrawAll();
        }

        /**
         * Loads an image from a source and calls resetView on success.
         */
        function loadImage(src) {
            image = new Image();
            image.onload = () => {
                canvasPlaceholder.style.display = 'none';
                if(fallbackUploadSection) fallbackUploadSection.classList.add('hidden');
                
                if (activeProjectName && projects[activeProjectName]) {
                    projects[activeProjectName].isDrawingLandscape = image.width > image.height;
                    saveProjects();
                }

                resetView(); // Use resetView to set initial scale and draw
            };
            image.onerror = () => {
                canvasPlaceholder.textContent = 'Gagal memuat denah. Silakan unggah denah baru di samping.';
                canvasPlaceholder.style.display = 'block';
                if(fallbackUploadSection) fallbackUploadSection.classList.remove('hidden');
            };
            image.src = src;
        }

        /**
         * Calculates the correct initial scale to make the image fit the container
         * while preserving its aspect ratio.
         */
        function fitImageToContainer() {
            if (!image) return;

            const containerWidth = canvasContainer.clientWidth;
            const containerHeight = canvasContainer.clientHeight;
            
            const imageAspectRatio = image.width / image.height;
            const containerAspectRatio = containerWidth / containerHeight;

            if (imageAspectRatio > containerAspectRatio) {
                // Image is wider than container, fit to width
                scale = containerWidth / image.width;
            } else {
                // Image is taller than container, fit to height
                scale = containerHeight / image.height;
            }
            panOffset = { x: 0, y: 0 };
        }

        function getInverseTransformedPoint(screenX, screenY) {
            let x = screenX - canvas.width / 2 - panOffset.x;
            let y = screenY - canvas.height / 2 - panOffset.y;
            const unscaledX = x / scale;
            const unscaledY = y / scale;
            const finalX = unscaledX + image.width / 2;
            const finalY = unscaledY + image.height / 2;
            return { x: finalX / image.width, y: finalY / image.height };
        }

        function getTransformedPoint(relativeX, relativeY) {
            let x = relativeX * image.width - image.width / 2;
            let y = relativeY * image.height - image.height / 2;
            x *= scale;
            y *= scale;
            return { 
                x: x + panOffset.x + canvas.width / 2, 
                y: y + panOffset.y + canvas.height / 2 
            };
        }
        
        // --- LocalStorage Functions ---
        function saveProjects() {
            localStorage.setItem('isolationProjects_v4', JSON.stringify(projects));
        }

        function loadProjects() {
            const savedProjects = localStorage.getItem('isolationProjects_v4');
            projects = savedProjects ? JSON.parse(savedProjects) : {};
            const lastActive = localStorage.getItem('lastActiveIsolationProject_v4');
            if (lastActive && projects[lastActive]) {
                loadProject(lastActive);
            } else {
                updateUIForNoProject();
            }
            renderProjectList();
        }

        // --- Project Management ---
        function createProject(name, imageData) {
            if (!name || projects[name]) {
                alert("Project name is invalid or already exists.");
                return;
            }
            projects[name] = {
                imageData: imageData,
                points: [],
                descriptionOfWork: '',
                isDrawingLandscape: true // Default value, will be updated on image load
            };
            saveProjects();
            loadProject(name);
            renderProjectList();
            projectNameInput.value = '';
        }

        function loadProject(name) {
            if (!projects[name]) return;
            activeProjectName = name;
            localStorage.setItem('lastActiveIsolationProject_v4', name);
            
            loadImage(projects[name].imageData);
            
            canvasPlaceholder.style.display = 'none';
            viewControls.classList.remove('hidden');
            projectDetailsSection.classList.remove('hidden');
            projectWorkDescInput.value = projects[activeProjectName].descriptionOfWork || '';
            
            renderProjectList();
            updatePointsList();
        }
    
    function deleteProject(name) {
        if (confirm(`Are you sure you want to delete the project "${name}"?`)) {
            delete projects[name];
            if (activeProjectName === name) {
                activeProjectName = null;
                localStorage.removeItem('lastActiveIsolationProject_v4');
                updateUIForNoProject();
            }
            saveProjects();
            renderProjectList();
        }
    }
    
    function updateUIForNoProject() {
         image = null;
         if(ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
         canvasPlaceholder.style.display = 'block';
         viewControls.classList.add('hidden');
         projectDetailsSection.classList.add('hidden');
         updatePointsList();
    }

    function renderProjectList() {
        projectList.innerHTML = '';
        Object.keys(projects).forEach(name => {
            const item = document.createElement('div');
            item.className = `sidebar-item flex justify-between items-center p-2 rounded-md cursor-pointer hover:bg-gray-100 ${name === activeProjectName ? 'active' : ''}`;
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = name;
            nameSpan.className = "flex-grow truncate";
            nameSpan.onclick = () => loadProject(name);
            
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex items-center flex-shrink-0 ml-2';

            const exportBtn = document.createElement('button');
            exportBtn.innerHTML = `<svg class="w-4 h-4 text-gray-400 hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`;
            exportBtn.onclick = (e) => { e.stopPropagation(); exportProject(name); };
            exportBtn.title = "Export Project";

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<svg class="w-4 h-4 text-gray-400 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteProject(name); };
            deleteBtn.title = "Delete Project";

            item.appendChild(nameSpan);
            buttonGroup.appendChild(exportBtn);
            buttonGroup.appendChild(deleteBtn);
            item.appendChild(buttonGroup);
            projectList.appendChild(item);
        });
    }

    // --- File Handling & Project I/O ---
    function handleFileUpload(file) {
        if (!file) return;
        let defaultProjectName = projectNameInput.value.trim() || file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
        
        const processFile = (dataUrl) => {
            let finalProjectName = defaultProjectName;
            let counter = 1;
            while(projects[finalProjectName]) { finalProjectName = `${defaultProjectName} (${counter++})`; }
            createProject(finalProjectName, dataUrl);
        };

        const reader = new FileReader();
        if (file.type.startsWith('image/')) {
            reader.onload = (event) => processFile(event.target.result);
            reader.readAsDataURL(file);
        } else if (file.type === 'application/pdf') {
            reader.onload = (event) => {
                pdfjsLib.getDocument({ data: event.target.result }).promise.then(pdf => {
                    if (pdf.numPages > 1) {
                        currentPdf = pdf;
                        currentPdfProcessCallback = processFile;
                        renderPdfThumbnails();
                        showPdfPagePreview(1, true); // true to reset view
                        pdfPageSelectorModal.classList.remove('hidden');
                    } else {
                        processSelectedPage(pdf, 1, processFile);
                    }
                }).catch(err => {
                    console.error(err);
                    alert('Failed to process PDF file.');
                });
            };
            reader.readAsArrayBuffer(file);
        } else {
            alert('Unsupported file format.');
        }
    }

    function renderPdfThumbnails() {
        pdfThumbnailsContainer.innerHTML = 'Rendering thumbnails...';
        const promises = [];
        for (let i = 1; i <= currentPdf.numPages; i++) {
            promises.push(currentPdf.getPage(i).then(page => {
                const viewport = page.getViewport({ scale: 1 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const scale = 150 / viewport.width;
                const scaledViewport = page.getViewport({ scale });
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                return page.render({ canvasContext: context, viewport: scaledViewport }).promise.then(() => {
                    const thumbnailWrapper = document.createElement('div');
                    thumbnailWrapper.className = 'pdf-thumbnail';
                    thumbnailWrapper.dataset.pageNum = i;
                    thumbnailWrapper.innerHTML = `<p class="text-center font-semibold mb-1">Page ${i}</p>`;
                    thumbnailWrapper.appendChild(canvas);
                    thumbnailWrapper.onclick = () => {
                        showPdfPagePreview(i, true); // true to reset view
                    };
                    return thumbnailWrapper;
                });
            }));
        }

        Promise.all(promises).then(thumbnails => {
            pdfThumbnailsContainer.innerHTML = '';
            thumbnails.forEach(thumb => pdfThumbnailsContainer.appendChild(thumb));
            updateSelectedThumbnail();
        });
    }

    function drawPreviewCanvas() {
        if (!previewPageCanvas || !previewPageCanvas.width) return;

        const context = pdfPreviewCanvas.getContext('2d');
        const container = pdfPreviewContainer;
        
        pdfPreviewCanvas.width = container.clientWidth;
        pdfPreviewCanvas.height = container.clientHeight;

        context.clearRect(0, 0, pdfPreviewCanvas.width, pdfPreviewCanvas.height);
        context.save();
        
        context.translate(
            pdfPreviewCanvas.width / 2 + previewPanOffset.x,
            pdfPreviewCanvas.height / 2 + previewPanOffset.y
        );
        
        context.drawImage(
            previewPageCanvas, 
            -previewPageCanvas.width / 2, 
            -previewPageCanvas.height / 2
        );
        context.restore();
    }

    function showPdfPagePreview(pageNum, reset = false) {
        if (!currentPdf || pageNum < 1 || pageNum > currentPdf.numPages) return;
        
        currentPageNumber = pageNum;

        currentPdf.getPage(pageNum).then(page => {
            const previewContainer = document.getElementById('pdf-preview-container');
            const viewport = page.getViewport({ scale: 1 });
            
            if (reset) {
                basePreviewScale = Math.min(previewContainer.clientWidth / viewport.width, previewContainer.clientHeight / viewport.height) * 0.95;
                previewScale = basePreviewScale;
                previewPanOffset = { x: 0, y: 0 };
            }

            const scaledViewport = page.getViewport({ scale: previewScale });
            
            previewPageCanvas.height = scaledViewport.height;
            previewPageCanvas.width = scaledViewport.width;
            const offscreenContext = previewPageCanvas.getContext('2d');

            page.render({ canvasContext: offscreenContext, viewport: scaledViewport }).promise.then(() => {
                drawPreviewCanvas();
            });

            pdfPageInfo.textContent = `Page ${currentPageNumber} of ${currentPdf.numPages}`;
            pdfPrevBtn.disabled = currentPageNumber === 1;
            pdfNextBtn.disabled = currentPageNumber === currentPdf.numPages;

            updateSelectedThumbnail();
        });
    }

    function resetPdfPreview() {
        showPdfPagePreview(currentPageNumber, true);
    }

    function updateSelectedThumbnail() {
        const thumbnails = document.querySelectorAll('.pdf-thumbnail');
        thumbnails.forEach(thumb => {
            if (parseInt(thumb.dataset.pageNum) === currentPageNumber) {
                thumb.classList.add('selected');
            } else {
                thumb.classList.remove('selected');
            }
        });
    }

    function processSelectedPage(pdf, pageNumber, callback) {
        pdf.getPage(pageNumber).then(page => {
            const desiredWidth = 2000;
            const viewport = page.getViewport({ scale: 1 });
            const scale = desiredWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale });
            const tempCanvas = document.createElement('canvas');
            tempCanvas.height = scaledViewport.height;
            tempCanvas.width = scaledViewport.width;
            const tempCtx = tempCanvas.getContext('2d');

            page.render({ canvasContext: tempCtx, viewport: scaledViewport }).promise.then(() => {
                callback(tempCanvas.toDataURL('image/jpeg', 0.9));
            });
        });
    }


    function exportProject(name) {
        const projectData = projects[name];
        if (!projectData) return;

        const jsonString = JSON.stringify(projectData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function handleProjectUpload(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const projectData = JSON.parse(event.target.result);
                
                // Basic validation
                if (!projectData.imageData || !projectData.points) {
                    throw new Error("Invalid project file format.");
                }

                let projectName = file.name.replace(/\.json$/, '');
                let finalProjectName = projectName;
                let counter = 1;
                while(projects[finalProjectName]) {
                    finalProjectName = `${projectName} (${counter++})`;
                }

                projects[finalProjectName] = projectData;
                saveProjects();
                renderProjectList();
                loadProject(finalProjectName);

            } catch (error) {
                alert(`Failed to upload project: ${error.message}`);
            } finally {
                uploadProjectInput.value = ''; // Reset input
            }
        };
        reader.readAsText(file);
    }

    // --- UI Updates ---
    function updatePointsList() {
        if (!activeProjectName || !projects[activeProjectName]) {
            pointsList.innerHTML = '';
            noPointsMessage.style.display = 'block';
            return;
        }
        const currentPoints = projects[activeProjectName].points.sort((a,b) => a.sequence - b.sequence);
        pointsList.innerHTML = '';
        if (currentPoints.length === 0) {
            noPointsMessage.style.display = 'block';
            return;
        }
        noPointsMessage.style.display = 'none';

        currentPoints.forEach(point => {
            const statusColor = point.status === 'isolated' ? 'red' : 'green';
            const listItem = document.createElement('div');
            listItem.className = `p-3 bg-gray-50 border-l-4 border-${statusColor}-500 rounded-r-lg cursor-pointer hover:bg-gray-100`;
            listItem.dataset.id = point.id;
            listItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-bold text-gray-800 truncate" title="${point.name}">${point.name}</p>
                    <span class="text-sm font-bold flex-shrink-0 ml-2 w-8 h-8 flex items-center justify-center bg-gray-200 text-gray-700 rounded-full">${point.sequence || '?'}</span>
                </div>
                <p class="text-xs text-gray-600 mt-1 truncate">Location: ${point.location || 'N/A'}</p>
                <p class="text-xs text-gray-500 mt-1 truncate">PIC: ${point.pic || 'N/A'}</p>
            `;
            listItem.addEventListener('click', () => openModal(point.id));
            pointsList.appendChild(listItem);
        });
    }

    function updateMarkers() {
        markerContainer.innerHTML = '';
        if (!image || !activeProjectName) return;

        projects[activeProjectName].points.forEach(point => {
            const pos = getTransformedPoint(point.x, point.y);
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.dataset.id = point.id;
            marker.style.backgroundColor = point.status === 'isolated' ? '#DC2626' : '#16A34A';
            marker.style.left = `${pos.x - 14}px`;
            marker.style.top = `${pos.y - 14}px`;
            marker.textContent = point.sequence || point.id;
            marker.addEventListener('click', (e) => {
                e.stopPropagation();
                openModal(point.id);
            });
            markerContainer.appendChild(marker);
        });
    }
    
    // --- Modal & Form Logic ---
    function openModal(id = null) {
        contextMenu.style.display = 'none';
        pointForm.reset();
        const currentPoints = projects[activeProjectName].points;
        if (id) {
            const point = currentPoints.find(p => p.id === id);
            if (!point) return;
            modalTitle.textContent = `Edit Isolation Point #${point.sequence || id}`;
            pointIdInput.value = point.id;
            pointSequenceInput.value = point.sequence || '';
            pointNameInput.value = point.name || '';
            pointLocationInput.value = point.location || '';
            pointDeviceTypeInput.value = point.deviceType || '';
            pointIsolationTypeInput.value = point.isolationType || 'Electrical';
            pointStatusInput.value = point.status || 'isolated';
            pointNormalPosInput.value = point.normalPos || '';
            pointIsolatedPosInput.value = point.isolatedPos || '';
            pointLockNoInput.value = point.lockNo || '';
            pointPicInput.value = point.pic || '';
            pointDatetimeInput.value = point.datetime || '';
            deletePointBtn.classList.remove('hidden');
        } else {
            const newId = currentPoints.length > 0 ? Math.max(...currentPoints.map(p => p.id)) + 1 : 1;
            const nextSequence = currentPoints.length > 0 ? Math.max(...currentPoints.map(p => parseInt(p.sequence) || 0)) + 1 : 1;
            modalTitle.textContent = 'Add New Isolation Point';
            pointIdInput.value = newId;
            pointSequenceInput.value = nextSequence;
            pointStatusInput.value = 'isolated';
            pointDatetimeInput.value = new Date().toISOString().slice(0, 16);
            deletePointBtn.classList.add('hidden');
        }
        pointModal.classList.remove('hidden');
        pointNameInput.focus();
    }

    function closeModal() {
        pointModal.classList.add('hidden');
    }

    pointForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = parseInt(pointIdInput.value);
        const pointData = {
            id,
            sequence: parseInt(pointSequenceInput.value) || 0,
            name: pointNameInput.value,
            location: pointLocationInput.value,
            deviceType: pointDeviceTypeInput.value,
            isolationType: pointIsolationTypeInput.value,
            status: pointStatusInput.value,
            normalPos: pointNormalPosInput.value,
            isolatedPos: pointIsolatedPosInput.value,
            lockNo: pointLockNoInput.value,
            pic: pointPicInput.value,
            datetime: pointDatetimeInput.value,
        };

        const currentPoints = projects[activeProjectName].points;
        const existingPointIndex = currentPoints.findIndex(p => p.id === id);

        if (existingPointIndex > -1) {
            currentPoints[existingPointIndex] = { ...currentPoints[existingPointIndex], ...pointData };
        } else {
            currentPoints.push({
                ...pointData,
                x: currentContextMenuPos.x,
                y: currentContextMenuPos.y,
            });
        }
        saveProjects();
        updatePointsList();
        updateMarkers();
        closeModal();
    });
    
    deletePointBtn.addEventListener('click', () => {
        const id = parseInt(pointIdInput.value);
        if (confirm(`Are you sure you want to delete this Isolation Point?`)) {
            projects[activeProjectName].points = projects[activeProjectName].points.filter(p => p.id !== id);
            saveProjects();
            updatePointsList();
            updateMarkers();
            closeModal();
        }
    });

    // --- Event Listeners & Initialisation ---

    // Initial Load
    loadProjects();

    // Setup event listeners
    window.addEventListener('resize', resetView); // Recalculate fit on resize
    closeModalBtn.addEventListener('click', closeModal);
    pointModal.addEventListener('click', (e) => e.target === pointModal && closeModal());
    closePdfModalBtn.addEventListener('click', () => pdfPageSelectorModal.classList.add('hidden'));

    resetViewBtn.addEventListener('click', resetView);

    sldUpload.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
    createProjectBtn.addEventListener('click', () => {
         const name = projectNameInput.value.trim();
         if (name) { sldUpload.click(); } 
         else { alert("Please enter a project name first."); }
    });

    uploadProjectInput.addEventListener('change', (e) => handleProjectUpload(e.target.files[0]));

    projectWorkDescInput.addEventListener('change', (e) => {
        if (activeProjectName && projects[activeProjectName]) {
            projects[activeProjectName].descriptionOfWork = e.target.value;
            saveProjects();
        }
    });

    fallbackUploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(file) {
             handleFileUpload(file);
             fallbackUploadSection.classList.add('hidden');
        }
    });
    
    canvasContainer.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (!image) return;
        const rect = canvas.getBoundingClientRect();
        const inversePos = getInverseTransformedPoint(e.clientX - rect.left, e.clientY - rect.top);
        if (inversePos.x >= 0 && inversePos.x <= 1 && inversePos.y >= 0 && inversePos.y <= 1) {
            currentContextMenuPos = inversePos;
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.display = 'block';
        }
    });

    document.addEventListener('click', (e) => !contextMenu.contains(e.target) && (contextMenu.style.display = 'none'));
    addPointMenuBtn.addEventListener('click', () => openModal());

    zoomInBtn.addEventListener('click', () => { scale *= 1.2; redrawAll(); });
    zoomOutBtn.addEventListener('click', () => { scale /= 1.2; redrawAll(); });

    pdfPrevBtn.addEventListener('click', () => showPdfPagePreview(currentPageNumber - 1, true));
    pdfNextBtn.addEventListener('click', () => showPdfPagePreview(currentPageNumber + 1, true));
    selectPdfPageBtn.addEventListener('click', () => {
        if (currentPdf && currentPdfProcessCallback) {
            processSelectedPage(currentPdf, currentPageNumber, currentPdfProcessCallback);
            pdfPageSelectorModal.classList.add('hidden');
        }
    });

    // PDF Preview Zoom and Pan
    zoomInPreviewBtn.addEventListener('click', () => { previewScale *= 1.2; showPdfPagePreview(currentPageNumber); });
    zoomOutPreviewBtn.addEventListener('click', () => { previewScale /= 1.2; showPdfPagePreview(currentPageNumber); });
    resetViewPreviewBtn.addEventListener('click', resetPdfPreview);

    pdfPreviewContainer.addEventListener('mousedown', (e) => {
        isPreviewPanning = true;
        previewPanStart.x = e.clientX - previewPanOffset.x;
        previewPanStart.y = e.clientY - previewPanOffset.y;
    });
    pdfPreviewContainer.addEventListener('mouseup', () => isPreviewPanning = false);
    pdfPreviewContainer.addEventListener('mouseleave', () => isPreviewPanning = false);
    pdfPreviewContainer.addEventListener('mousemove', (e) => {
        if (isPreviewPanning) {
            previewPanOffset.x = e.clientX - previewPanStart.x;
            previewPanOffset.y = e.clientY - previewPanStart.y;
            drawPreviewCanvas();
        }
    });


    canvasContainer.addEventListener('mousedown', (e) => {
        if (e.target === canvas) {
            isPanning = true;
            panStart.x = e.clientX - panOffset.x;
            panStart.y = e.clientY - panOffset.y;
        }
    });
    canvasContainer.addEventListener('mouseup', () => isPanning = false);
    canvasContainer.addEventListener('mouseleave', () => isPanning = false);
    canvasContainer.addEventListener('mousemove', (e) => {
        if (isPanning) {
            panOffset.x = e.clientX - panStart.x;
            panOffset.y = e.clientY - panStart.y;
            redrawAll();
        }
    });
    
    // --- Report Generation ---
    printReportBtn.addEventListener('click',  () => {
        if (!image || !activeProjectName) return;

        const isDrawingLandscape = projects[activeProjectName].isDrawingLandscape;
        const doc = new jsPDF({ orientation: isDrawingLandscape ? 'landscape' : 'portrait' });

        const sortedPoints = [...projects[activeProjectName].points].sort((a, b) => a.sequence - b.sequence);
        const descriptionOfWork = projects[activeProjectName].descriptionOfWork || 'N/A';

        // Page 1: Image
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`Attachment: Marked Drawing for ${activeProjectName}`, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = image.width;
        tempCanvas.height = image.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(image, 0, 0);
        
        sortedPoints.forEach(point => {
            const x = point.x * tempCanvas.width;
            const y = point.y * tempCanvas.height;
            const radius = Math.min(tempCanvas.width, tempCanvas.height) * 0.012;
            tempCtx.fillStyle = '#DC2626'; // Always red for LOTO
            tempCtx.beginPath();
            tempCtx.arc(x, y, radius, 0, 2 * Math.PI);
            tempCtx.fill();
            tempCtx.strokeStyle = 'white';
            tempCtx.lineWidth = radius * 0.15;
            tempCtx.stroke();
            tempCtx.fillStyle = 'white';
            tempCtx.font = `bold ${radius}px Inter`;
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';
            tempCtx.fillText(point.sequence, x, y);
        });
        
        const imageDataUrl = tempCanvas.toDataURL('image/jpeg', 0.8);
        const imgProps = doc.getImageProperties(imageDataUrl);
        const margin = 14;
        const pdfWidth = doc.internal.pageSize.getWidth() - (2 * margin);
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        const pageHeight = doc.internal.pageSize.getHeight();
        const imageY = 25;
        let finalImageHeight = Math.min(pdfHeight, pageHeight - imageY - margin);
        let finalImageWidth = (finalImageHeight * imgProps.width) / imgProps.height;
        let finalImageX = (doc.internal.pageSize.getWidth() - finalImageWidth) / 2;


        doc.addImage(imageDataUrl, 'JPEG', finalImageX, imageY, finalImageWidth, finalImageHeight);

        // Page 2: Table (Always Landscape)
        doc.addPage(undefined, 'l');
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('LOCK OUT TAG OUT EQUIPMENT LIST', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Description of Work:', 14, 25);
        doc.text(descriptionOfWork, 48, 25);
        doc.text(`Date of Reviewed: ${new Date().toLocaleDateString('en-GB')}`, doc.internal.pageSize.getWidth() - 14, 25, { align: 'right' });
        doc.text(`Page: 1 of 1`, doc.internal.pageSize.getWidth() - 14, 32, { align: 'right' });


        const tableData = sortedPoints.map(p => {
            const date = p.datetime ? new Date(p.datetime) : null;
            const formattedDate = date ? `${date.toLocaleDateString('en-GB')} ${date.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'})}` : '';
            return [
                p.sequence,
                p.name,
                p.location,
                p.isolationType === 'Physical' ? 'X' : '', // PHYSICAL (LOTO/CTRL/NL)
                '', // Lock closed
                '', // Lock open
                '', // Blinded
                '', // Spade
                '', // Disconnected
                '', // Energized
                p.isolationType === 'Electrical' ? 'X' : '', // De-energized
                p.deviceType,
                p.normalPos, // Normal Run Position
                p.isolatedPos, // Isolation Position
                formattedDate, // Isolation Date/Time
                p.lockNo, // Isolation Tag/Lock No.
                p.pic, // Isolation PIC
                '', // De-iso Position
                '', // De-iso Date/Time
                '', // De-iso Tag/Lock No.
                ''  // De-iso PIC
            ];
        });

        doc.autoTable({
            head: [
                [
                    { content: 'Isolation Points', colSpan: 3, styles: { halign: 'center', fillColor: [255, 255, 255], textColor: 0, lineColor: 0, lineWidth: 0.1 } },
                    { content: 'Isolation Device Type', colSpan: 8, styles: { halign: 'center', fillColor: [255, 255, 255], textColor: 0, lineColor: 0, lineWidth: 0.1 } },
                    { content: 'Normal Run', colSpan: 1, styles: { halign: 'center', fillColor: [255, 255, 255], textColor: 0, lineColor: 0, lineWidth: 0.1 } },
                    { content: 'Isolation', colSpan: 4, styles: { halign: 'center', fillColor: [255, 255, 255], textColor: 0, lineColor: 0, lineWidth: 0.1 } },
                    { content: 'De-Isolation', colSpan: 4, styles: { halign: 'center', fillColor: [255, 255, 255], textColor: 0, lineColor: 0, lineWidth: 0.1 } }
                ],
                [
                    { content: 'NO', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Equipment Name/Tag', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Location', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'PHYSICAL (LOTO/CTRL/NL)', colSpan: 6, styles: { halign: 'center' } },
                    { content: 'Electrical', colSpan: 2, styles: { halign: 'center' } },
                    { content: 'Position', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Position', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Date/Time', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Tag No./Lock No.', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'PIC', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Position', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Date/Time', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'Tag No./Lock No.', rowSpan: 2, styles: { valign: 'middle' } },
                    { content: 'PIC', rowSpan: 2, styles: { valign: 'middle' } }
                ],
                ['Lock closed', 'Lock open', 'Blinded', 'Spade', 'Disconnected', 'Energized', 'De-energized', 'Device Type']
            ],
            body: tableData,
            margin: { top: 40, right: 10, bottom: 10, left: 10 },
            theme: 'grid',
            headStyles: { fillColor: [255, 255, 255], textColor: 0, fontSize: 6, lineColor: 0, lineWidth: 0.1, halign: 'center' },
            styles: { fontSize: 6, cellPadding: 1, overflow: 'linebreak', lineColor: 0, lineWidth: 0.1 },
            columnStyles: {
                0: { halign: 'center', cellWidth: 8 }, 1: { cellWidth: 30 }, 2: { cellWidth: 22 },
                3: { halign: 'center', cellWidth: 10 }, 4: { halign: 'center', cellWidth: 10 },
                5: { halign: 'center', cellWidth: 10 }, 6: { halign: 'center', cellWidth: 10 },
                7: { halign: 'center', cellWidth: 10 }, 8: { halign: 'center', cellWidth: 10 },
                9: { halign: 'center', cellWidth: 10 }, 10: { halign: 'center', cellWidth: 10 },
                11: { cellWidth: 15 }, 12: { cellWidth: 15 }, 13: { cellWidth: 18 }, 14: { cellWidth: 18 }, 15: { cellWidth: 15 },
                16: { cellWidth: 15 }, 17: { cellWidth: 18 }, 18: { cellWidth: 18 }, 19: { cellWidth: 15 }
            }
        });

        doc.save(`${activeProjectName}-LOTO-Report.pdf`);
        
        exportProject(activeProjectName);
    });
});
</script>
</body>
</html>
